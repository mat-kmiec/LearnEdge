<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>LearnEdge ‚Äì M√≥j profil</title>
    <link rel="icon" type="image/x-icon" th:href="@{/img/favicon.ico}" href="../../static/img/favicon.ico"/>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Custom -->
    <link
      th:href="@{/css/pages/dashboard.css}"
      href="../../static/css/pages/dashboard.css"
      rel="stylesheet"
    />

    <style>
      
    </style>
  </head>

  <body>
    <nav th:replace="~{fragments/nav :: navbar}"></nav>

    <!-- Zawarto≈õƒá -->
    <div class="container py-5">
      <div class="dashboard-container">
        <div class="dashboard-header text-center mb-5">
          <h1 class="mb-2">M√≥j profil</h1>
          <p class="text-light opacity-75 small mb-0">
            ZarzƒÖdzaj swoim kontem, aktualizuj dane i dbaj o bezpiecze≈Ñstwo swojego profilu.
          </p>
        </div>

        <div class="row g-4">
          <!-- Dane u≈ºytkownika -->
          <div class="col-lg-4 text-center">
            <div class="profile-card h-100 d-flex flex-column align-items-center justify-content-center">
              <img
                th:src="${#authentication.principal.profilePicture != null ? #authentication.principal.profilePicture : 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
                alt="Avatar"
                class="profile-avatar mb-3"
                id="profileImage"
              />
              <h4 class="fw-bold" th:text="${#authentication.principal.firstName + ' ' + #authentication.principal.lastName}">Jan Kowalski</h4>
              <p class="text-light small mb-3" th:text="${#authentication.principal.email}">jan.kowalski@example.com</p>
              <input type="file" 
                     id="profilePictureInput" 
                     accept="image/*" 
                     style="display: none;"
                     onchange="handleProfilePictureChange(this)">
              <button class="btn btn-gradient btn-sm w-100" onclick="document.getElementById('profilePictureInput').click()">
                <i class="bi bi-camera me-2"></i> Zmie≈Ñ zdjƒôcie
              </button>
            </div>
          </div>

          <!-- Dane osobiste -->
          <div class="col-lg-8">
            <div class="profile-card h-100">
              <div class="profile-section-title">
                <i class="bi bi-person-circle"></i> Dane u≈ºytkownika
              </div>
              <div th:if="${success}" class="alert alert-success mb-3" role="alert">
                <i class="bi bi-check-circle me-2"></i>
                <span th:text="${success}">Profil zosta≈Ç zaktualizowany.</span>
              </div>
              <div th:if="${error}" class="alert alert-danger mb-3" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <span th:text="${error}">WystƒÖpi≈Ç b≈ÇƒÖd podczas aktualizacji profilu.</span>
              </div>
              <form th:action="@{/profil}" method="post" th:object="${profile}">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="firstName">Imiƒô</label>
                    <input
                      type="text"
                      class="form-control"
                      id="firstName"
                      th:field="*{firstName}"
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="lastName">Nazwisko</label>
                    <input
                      type="text"
                      class="form-control"
                      id="lastName"
                      th:field="*{lastName}"
                    />
                  </div>
                </div>
                <button type="submit" class="btn btn-gradient w-100 mt-3">
                  <i class="bi bi-save me-2"></i> Zaktualizuj dane
                </button>
              </form>
            </div>
          </div>
          <!-- Styl uczenia siƒô -->
<div class="col-lg-12">
  <div class="profile-card mt-3">
    <div class="profile-section-title">
      <i class="bi bi-lightbulb"></i> Styl uczenia siƒô
    </div>
    
    <!-- Success alert (hidden by default) -->
    <div id="learningStyleSuccess" class="alert alert-success alert-dismissible fade" role="alert" style="display: none;">
      <i class="bi bi-check-circle me-2"></i>
      <span id="learningStyleSuccessMessage">Styl uczenia siƒô zosta≈Ç zapisany!</span>
      <button type="button" class="btn-close" onclick="document.getElementById('learningStyleSuccess').style.display='none'"></button>
    </div>
    
    <!-- Error alert (hidden by default) -->
    <div id="learningStyleError" class="alert alert-danger alert-dismissible fade" role="alert" style="display: none;">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <span id="learningStyleErrorMessage"></span>
      <button type="button" class="btn-close" onclick="document.getElementById('learningStyleError').style.display='none'"></button>
    </div>
    
    <p class="text-light small mb-4">
      Wybierz sw√≥j styl uczenia siƒô rƒôcznie lub pozw√≥l naszemu botowi AI
      pom√≥c Ci go okre≈õliƒá na podstawie kr√≥tkiej ankiety.
    </p>

    <div class="d-flex flex-column flex-md-row align-items-md-center gap-3">
      <!-- Select -->
      <div class="flex-fill">
  <label for="learningStyle" class="form-label mb-1 text-light small"
    >Wybierz styl rƒôcznie</label
  >
  <select id="learningStyle" class="custom-select-learnedge w-100">
    <option selected disabled>-- wybierz styl --</option>
    <option value="VISUAL">üëÅÔ∏è Wzrokowiec</option>
    <option value="AUDITORY">üéß S≈Çuchowiec</option>
    <option value="KINESTHETIC">‚úã Kinestetyk</option>
  </select>
</div>

      <!-- Przyciski -->
      <div class="d-flex flex-column flex-fill flex-md-row gap-2 mt-2 mt-md-4">
        <button class="btn btn-gradient flex-fill" onclick="saveLearningStyle(); return false;">
          <i class="bi bi-save me-2"></i> Zapisz styl
        </button>
        <a
          th:href="@{/ankieta}"
          href="ankieta.html"
          class="btn btn-outline-primary flex-fill"
        >
          <i class="bi bi-robot me-2"></i> Wype≈Çnij ankietƒô AI
        </a>
      </div>
    </div>

    <!-- Aktualny styl u≈ºytkownika -->
    <div class="mt-4 d-flex align-items-center gap-3" id="currentLearningStyleDisplay">
      <i class="bi bi-person-check text-accent fs-4"></i>
      <p class="mb-0 text-light small">
        Tw√≥j aktualny styl uczenia: <strong class="text-accent" id="currentLearningStyleText" th:text="${#authentication.principal.learningStyle != null ? (#authentication.principal.learningStyle == 'VISUAL' ? 'üëÅÔ∏è Wzrokowiec' : (#authentication.principal.learningStyle == 'AUDITORY' ? 'üéß S≈Çuchowiec' : '‚úã Kinestetyk')) : 'Nie ustawiono'}">Nie ustawiono</strong>
      </p>
    </div>
  </div>
</div>


          <!-- Zmiana has≈Ça -->
          <div class="col-lg-12">
            <div class="profile-card mt-3">
              <div class="profile-section-title">
                <i class="bi bi-shield-lock"></i> Zmiana has≈Ça
              </div>
              <!-- Alerts for change password -->
              <div id="changePasswordSuccess" class="alert alert-success alert-dismissible fade" role="alert" style="display: none;">
                <i class="bi bi-check-circle me-2"></i>
                <span id="changePasswordSuccessMessage">Has≈Ço zosta≈Ço zmienione.</span>
                <button type="button" class="btn-close" onclick="document.getElementById('changePasswordSuccess').style.display='none'"></button>
              </div>
              <div id="changePasswordError" class="alert alert-danger alert-dismissible fade" role="alert" style="display: none;">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <span id="changePasswordErrorMessage"></span>
                <button type="button" class="btn-close" onclick="document.getElementById('changePasswordError').style.display='none'"></button>
              </div>

              <form class="row" id="changePasswordForm" onsubmit="return changePassword(event)">
                <div class="col-md-4 mb-3">
                  <label for="currentPassword">Obecne has≈Ço</label>
                  <div class="input-group">
                    <input
                      type="password"
                      class="form-control"
                      id="currentPassword"
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    />
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('currentPassword')">
                      <i class="bi bi-eye" id="currentPassword-icon"></i>
                    </button>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="newPassword">Nowe has≈Ço</label>
                  <div class="input-group">
                    <input
                      type="password"
                      class="form-control"
                      id="newPassword"
                      placeholder="Nowe has≈Ço"
                    />
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('newPassword')">
                      <i class="bi bi-eye" id="newPassword-icon"></i>
                    </button>
                  </div>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="confirmPassword">Powt√≥rz has≈Ço</label>
                  <div class="input-group">
                    <input
                      type="password"
                      class="form-control"
                      id="confirmPassword"
                      placeholder="Powt√≥rz nowe has≈Ço"
                    />
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('confirmPassword')">
                      <i class="bi bi-eye" id="confirmPassword-icon"></i>
                    </button>
                  </div>
                </div>
                <div class="col-12">
                  <button type="submit" class="btn btn-gradient w-100 mt-2">
                    <i class="bi bi-arrow-repeat me-2"></i> Zmie≈Ñ has≈Ço
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="text-center mt-5 opacity-75">
          <p class="small mb-0">
            Pamiƒôtaj, aby chroniƒá swoje dane i nie udostƒôpniaƒá nikomu swojego
            has≈Ça.
          </p>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
  <script>
  function handleProfilePictureChange(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
      console.log('Selected file:', file?.name, file?.type, file?.size);
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Plik jest zbyt du≈ºy. Maksymalny rozmiar to 5MB.');
                return;
            }
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                alert('Proszƒô wybraƒá plik graficzny.');
                return;
            }

            const formData = new FormData();
            formData.append('profilePicture', file);

      // CSRF
      const tokenEl = document.querySelector('meta[name="_csrf"]');
      const headerEl = document.querySelector('meta[name="_csrf_header"]');
      const csrfToken = tokenEl ? tokenEl.getAttribute('content') : null;
      const csrfHeader = headerEl ? headerEl.getAttribute('content') : null;

      const headers = {};
      if (csrfToken && csrfHeader) {
        headers[csrfHeader] = csrfToken;
      } else {
        console.warn('CSRF meta tags not found');
      }

      fetch('/api/profile/picture', {
                method: 'POST',
        body: formData,
        credentials: 'same-origin',
        headers
            })
            .then(response => {
        console.log('Upload response status:', response.status);
        return response.text().then(text => {
          let data;
          try { data = text ? JSON.parse(text) : {}; } catch(e) { data = { error: text || 'Nieznany b≈ÇƒÖd' }; }
          if (!response.ok) {
            const msg = (data && (data.error || data.message)) || 'B≈ÇƒÖd podczas przesy≈Çania zdjƒôcia';
            throw new Error(msg);
          }
          return data;
        });
            })
      .then(data => {
        // Update the image preview
        if (data && data.url) {
          const urlWithBuster = data.url + (data.url.includes('?') ? '&' : '?') + 't=' + Date.now();
          console.log('Setting new profile image URL:', urlWithBuster);
          document.getElementById('profileImage').src = urlWithBuster;
        } else {
          console.warn('No URL returned from server', data);
        }
            })
            .catch(error => {
        console.error('Upload error:', error);
        alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas przesy≈Çania zdjƒôcia: ' + (error?.message || 'Spr√≥buj ponownie.'));
            });
        }
    }

    function togglePasswordVisibility(fieldId) {
        const input = document.getElementById(fieldId);
        const icon = document.getElementById(fieldId + '-icon');
        
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('bi-eye');
            icon.classList.add('bi-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('bi-eye-slash');
            icon.classList.add('bi-eye');
        }
    }

    function saveLearningStyle() {
        const select = document.getElementById('learningStyle');
        const learningStyle = select.value;
        
        // Hide any previous alerts
        document.getElementById('learningStyleSuccess').style.display = 'none';
        document.getElementById('learningStyleError').style.display = 'none';
        
        if (!learningStyle || learningStyle === '-- wybierz styl --') {
            showLearningStyleError('Proszƒô wybraƒá styl uczenia siƒô');
            return;
        }

        // Get CSRF token
        const tokenEl = document.querySelector('meta[name="_csrf"]');
        const headerEl = document.querySelector('meta[name="_csrf_header"]');
        const csrfToken = tokenEl ? tokenEl.getAttribute('content') : null;
        const csrfHeader = headerEl ? headerEl.getAttribute('content') : null;

        const headers = {
            'Content-Type': 'application/json'
        };
        if (csrfToken && csrfHeader) {
            headers[csrfHeader] = csrfToken;
        }

        fetch('/api/profile/learning-style', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ learningStyle: learningStyle }),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showLearningStyleError('B≈ÇƒÖd: ' + data.error);
            } else {
                // Update display
                const styleNames = {
                    'VISUAL': 'üëÅÔ∏è Wzrokowiec',
                    'AUDITORY': 'üéß S≈Çuchowiec',
                    'KINESTHETIC': '‚úã Kinestetyk'
                };
                document.getElementById('currentLearningStyleText').textContent = styleNames[learningStyle];
                showLearningStyleSuccess('Styl uczenia siƒô zosta≈Ç zapisany!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showLearningStyleError('WystƒÖpi≈Ç b≈ÇƒÖd podczas zapisywania stylu uczenia siƒô');
        });
    }

    function showLearningStyleSuccess(message) {
        const alert = document.getElementById('learningStyleSuccess');
        document.getElementById('learningStyleSuccessMessage').textContent = message;
        alert.style.display = 'block';
        alert.classList.add('show');
        
        // Scroll to alert
        alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.style.display = 'none', 150);
        }, 5000);
    }

    function showLearningStyleError(message) {
        const alert = document.getElementById('learningStyleError');
        document.getElementById('learningStyleErrorMessage').textContent = message;
        alert.style.display = 'block';
        alert.classList.add('show');
        
        // Scroll to alert
        alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

  function showChangePasswordSuccess(message) {
    const alert = document.getElementById('changePasswordSuccess');
    document.getElementById('changePasswordSuccessMessage').textContent = message || 'Has≈Ço zosta≈Ço zmienione.';
    alert.style.display = 'block';
    alert.classList.add('show');
    alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    setTimeout(() => {
      alert.classList.remove('show');
      setTimeout(() => alert.style.display = 'none', 150);
    }, 5000);
  }

  function showChangePasswordError(message) {
    const alert = document.getElementById('changePasswordError');
    document.getElementById('changePasswordErrorMessage').textContent = message || 'Nie uda≈Ço siƒô zmieniƒá has≈Ça';
    alert.style.display = 'block';
    alert.classList.add('show');
    alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function changePassword(event) {
    if (event) event.preventDefault();

    // Hide previous alerts
    document.getElementById('changePasswordSuccess').style.display = 'none';
    document.getElementById('changePasswordError').style.display = 'none';

    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    if (!currentPassword || !newPassword || !confirmPassword) {
      showChangePasswordError('Wszystkie pola sƒÖ wymagane');
      return false;
    }
    if (newPassword.length < 8) {
      showChangePasswordError('Nowe has≈Ço musi mieƒá co najmniej 8 znak√≥w');
      return false;
    }
    if (newPassword !== confirmPassword) {
      showChangePasswordError('Has≈Ça nie sƒÖ takie same');
      return false;
    }
    if (newPassword === currentPassword) {
      showChangePasswordError('Nowe has≈Ço nie mo≈ºe byƒá takie samo jak obecne');
      return false;
    }

    // CSRF
    const tokenEl = document.querySelector('meta[name="_csrf"]');
    const headerEl = document.querySelector('meta[name="_csrf_header"]');
    const csrfToken = tokenEl ? tokenEl.getAttribute('content') : null;
    const csrfHeader = headerEl ? headerEl.getAttribute('content') : null;

    const headers = { 'Content-Type': 'application/json' };
    if (csrfToken && csrfHeader) headers[csrfHeader] = csrfToken;

    fetch('/api/profile/change-password', {
      method: 'POST',
      headers,
      credentials: 'same-origin',
      body: JSON.stringify({ currentPassword, newPassword })
    })
    .then(resp => resp.text().then(text => {
      let data; try { data = text ? JSON.parse(text) : {}; } catch(e) { data = { error: text || 'B≈ÇƒÖd' }; }
      return { ok: resp.ok, data };
    }))
    .then(({ ok, data }) => {
      if (!ok || data.error) {
        showChangePasswordError(data.error || 'WystƒÖpi≈Ç b≈ÇƒÖd podczas zmiany has≈Ça');
      } else {
        showChangePasswordSuccess('Has≈Ço zosta≈Ço zmienione.');
        // Clear inputs
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
      }
    })
    .catch(err => {
      console.error('Change password error:', err);
      showChangePasswordError('WystƒÖpi≈Ç b≈ÇƒÖd podczas zmiany has≈Ça');
    });

    return false;
  }

  // Set current learning style when page loads
  document.addEventListener('DOMContentLoaded', function() {
    const currentStyleElement = document.getElementById('currentLearningStyleText');
    const selectElement = document.getElementById('learningStyle');
    
    if (currentStyleElement && selectElement) {
      const currentStyleText = currentStyleElement.textContent.trim();
      
      // Map display text to values
      let currentStyleValue = null;
      if (currentStyleText.includes('Wzrokowiec')) {
        currentStyleValue = 'VISUAL';
      } else if (currentStyleText.includes('S≈Çuchowiec')) {
        currentStyleValue = 'AUDITORY';
      } else if (currentStyleText.includes('Kinestetyk')) {
        currentStyleValue = 'KINESTHETIC';
      }
      
      // Set the select value
      if (currentStyleValue) {
        selectElement.value = currentStyleValue;
      }
    }
  });
    </script>
  </body>
</html>
