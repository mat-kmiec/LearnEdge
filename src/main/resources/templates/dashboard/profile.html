<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>LearnEdge ‚Äì M√≥j profil</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Custom -->
    <link
      th:href="@{/css/pages/dashboard.css}"
      href="../../static/css/pages/dashboard.css"
      rel="stylesheet"
    />

    <style>
      
    </style>
  </head>

  <body>
    <nav th:replace="~{fragments/nav :: navbar}"></nav>

    <!-- Zawarto≈õƒá -->
    <div class="container py-5">
      <div class="dashboard-container">
        <div class="dashboard-header text-center mb-5">
          <h1 class="mb-2">M√≥j profil</h1>
          <p class="text-light opacity-75 small mb-0">
            ZarzƒÖdzaj swoim kontem, aktualizuj dane i dbaj o bezpiecze≈Ñstwo swojego profilu.
          </p>
        </div>

        <div class="row g-4">
          <!-- Dane u≈ºytkownika -->
          <div class="col-lg-4 text-center">
            <div class="profile-card h-100 d-flex flex-column align-items-center justify-content-center">
              <img
                th:src="${#authentication.principal.profilePicture != null ? #authentication.principal.profilePicture : 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
                alt="Avatar"
                class="profile-avatar mb-3"
                id="profileImage"
              />
              <h4 class="fw-bold" th:text="${#authentication.principal.firstName + ' ' + #authentication.principal.lastName}">Jan Kowalski</h4>
              <p class="text-light small mb-3" th:text="${#authentication.principal.email}">jan.kowalski@example.com</p>
              <input type="file" 
                     id="profilePictureInput" 
                     accept="image/*" 
                     style="display: none;"
                     onchange="handleProfilePictureChange(this)">
              <button class="btn btn-gradient btn-sm w-100" onclick="document.getElementById('profilePictureInput').click()">
                <i class="bi bi-camera me-2"></i> Zmie≈Ñ zdjƒôcie
              </button>
            </div>
          </div>

          <!-- Dane osobiste -->
          <div class="col-lg-8">
            <div class="profile-card h-100">
              <div class="profile-section-title">
                <i class="bi bi-person-circle"></i> Dane u≈ºytkownika
              </div>
              <div th:if="${success}" class="alert alert-success mb-3" role="alert">
                <i class="bi bi-check-circle me-2"></i>
                <span th:text="${success}">Profil zosta≈Ç zaktualizowany.</span>
              </div>
              <div th:if="${error}" class="alert alert-danger mb-3" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <span th:text="${error}">WystƒÖpi≈Ç b≈ÇƒÖd podczas aktualizacji profilu.</span>
              </div>
              <form th:action="@{/profil}" method="post" th:object="${profile}">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="firstName">Imiƒô</label>
                    <input
                      type="text"
                      class="form-control"
                      id="firstName"
                      th:field="*{firstName}"
                    />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="lastName">Nazwisko</label>
                    <input
                      type="text"
                      class="form-control"
                      id="lastName"
                      th:field="*{lastName}"
                    />
                  </div>
                </div>
                <button type="submit" class="btn btn-gradient w-100 mt-3">
                  <i class="bi bi-save me-2"></i> Zaktualizuj dane
                </button>
              </form>
            </div>
          </div>
          <!-- Styl uczenia siƒô -->
<div class="col-lg-12">
  <div class="profile-card mt-3">
    <div class="profile-section-title">
      <i class="bi bi-lightbulb"></i> Styl uczenia siƒô
    </div>
    <p class="text-light small mb-4">
      Wybierz sw√≥j styl uczenia siƒô rƒôcznie lub pozw√≥l naszemu botowi AI
      pom√≥c Ci go okre≈õliƒá na podstawie kr√≥tkiej ankiety.
    </p>

    <div class="d-flex flex-column flex-md-row align-items-md-center gap-3">
      <!-- Select -->
      <div class="flex-fill">
  <label for="learningStyle" class="form-label mb-1 text-light small"
    >Wybierz styl rƒôcznie</label
  >
  <select id="learningStyle" class="custom-select-learnedge w-100">
    <option selected disabled>-- wybierz styl --</option>
    <option value="VISUAL">üëÅÔ∏è Wzrokowiec</option>
    <option value="AUDITORY">üéß S≈Çuchowiec</option>
    <option value="KINESTHETIC">‚úã Kinestetyk</option>
  </select>
</div>

      <!-- Przyciski -->
      <div class="d-flex flex-column flex-fill flex-md-row gap-2 mt-2 mt-md-4">
        <button class="btn btn-gradient flex-fill">
          <i class="bi bi-save me-2"></i> Zapisz styl
        </button>
        <a
          th:href="@{/ankieta}"
          href="ankieta.html"
          class="btn btn-outline-primary flex-fill"
        >
          <i class="bi bi-robot me-2"></i> Wype≈Çnij ankietƒô AI
        </a>
      </div>
    </div>

    <!-- Aktualny styl u≈ºytkownika -->
    <div class="mt-4 d-flex align-items-center gap-3">
      <i class="bi bi-person-check text-accent fs-4"></i>
      <p class="mb-0 text-light small">
        Tw√≥j aktualny styl uczenia: <strong class="text-accent">Wzrokowiec</strong>
      </p>
    </div>
  </div>
</div>


          <!-- Zmiana has≈Ça -->
          <div class="col-lg-12">
            <div class="profile-card mt-3">
              <div class="profile-section-title">
                <i class="bi bi-shield-lock"></i> Zmiana has≈Ça
              </div>
              <form class="row">
                <div class="col-md-4 mb-3">
                  <label for="currentPassword">Obecne has≈Ço</label>
                  <input
                    type="password"
                    class="form-control"
                    id="currentPassword"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="newPassword">Nowe has≈Ço</label>
                  <input
                    type="password"
                    class="form-control"
                    id="newPassword"
                    placeholder="Nowe has≈Ço"
                  />
                </div>
                <div class="col-md-4 mb-3">
                  <label for="confirmPassword">Powt√≥rz has≈Ço</label>
                  <input
                    type="password"
                    class="form-control"
                    id="confirmPassword"
                    placeholder="Powt√≥rz nowe has≈Ço"
                  />
                </div>
                <div class="col-12">
                  <button type="submit" class="btn btn-gradient w-100 mt-2">
                    <i class="bi bi-arrow-repeat me-2"></i> Zmie≈Ñ has≈Ço
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="text-center mt-5 opacity-75">
          <p class="small mb-0">
            Pamiƒôtaj, aby chroniƒá swoje dane i nie udostƒôpniaƒá nikomu swojego
            has≈Ça.
          </p>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
  <script>
  function handleProfilePictureChange(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
      console.log('Selected file:', file?.name, file?.type, file?.size);
            
            // Check file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Plik jest zbyt du≈ºy. Maksymalny rozmiar to 5MB.');
                return;
            }
            
            // Check file type
            if (!file.type.startsWith('image/')) {
                alert('Proszƒô wybraƒá plik graficzny.');
                return;
            }

            const formData = new FormData();
            formData.append('profilePicture', file);

      // CSRF
      const tokenEl = document.querySelector('meta[name="_csrf"]');
      const headerEl = document.querySelector('meta[name="_csrf_header"]');
      const csrfToken = tokenEl ? tokenEl.getAttribute('content') : null;
      const csrfHeader = headerEl ? headerEl.getAttribute('content') : null;

      const headers = {};
      if (csrfToken && csrfHeader) {
        headers[csrfHeader] = csrfToken;
      } else {
        console.warn('CSRF meta tags not found');
      }

      fetch('/api/profile/picture', {
                method: 'POST',
        body: formData,
        credentials: 'same-origin',
        headers
            })
            .then(response => {
        console.log('Upload response status:', response.status);
        return response.text().then(text => {
          let data;
          try { data = text ? JSON.parse(text) : {}; } catch(e) { data = { error: text || 'Nieznany b≈ÇƒÖd' }; }
          if (!response.ok) {
            const msg = (data && (data.error || data.message)) || 'B≈ÇƒÖd podczas przesy≈Çania zdjƒôcia';
            throw new Error(msg);
          }
          return data;
        });
            })
      .then(data => {
        // Update the image preview
        if (data && data.url) {
          const urlWithBuster = data.url + (data.url.includes('?') ? '&' : '?') + 't=' + Date.now();
          console.log('Setting new profile image URL:', urlWithBuster);
          document.getElementById('profileImage').src = urlWithBuster;
        } else {
          console.warn('No URL returned from server', data);
        }
            })
            .catch(error => {
        console.error('Upload error:', error);
        alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas przesy≈Çania zdjƒôcia: ' + (error?.message || 'Spr√≥buj ponownie.'));
            });
        }
    }
    </script>
  </body>
</html>
